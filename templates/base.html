<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cekfisi.fra1.cdn.digitaloceanspaces.com">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    
    <!-- Preload LCP Image (Hero Banner) for faster rendering -->
    {% if banner_images.0.image %}
    <link rel="preload" as="image" href="{{ banner_images.0.image.url }}" fetchpriority="high">
    {% endif %}
    
    <!-- Primary Meta Tags -->
    <title>{% block title %}{% if seo_settings and seo_settings.meta_title %}{{ seo_settings.meta_title }}{% else %}Emlak{% endif %}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{% if seo_settings and seo_settings.meta_description %}{{ seo_settings.meta_description }}{% else %}Profesyonel emlak hizmetleri. Daire, villa, arsa ve diğer gayrimenkuller için en iyi fiyatlar.{% endif %}{% endblock %}">
    {% if seo_settings and seo_settings.meta_keywords %}
    <meta name="keywords" content="{{ seo_settings.meta_keywords }}">
    {% endif %}
    {% if seo_settings and seo_settings.robots %}
    <meta name="robots" content="{{ seo_settings.robots }}">
    {% else %}
    <meta name="robots" content="index,follow">
    {% endif %}
    
    <!-- Canonical URL -->
    {% if seo_settings and seo_settings.canonical_url %}
    <link rel="canonical" href="{{ seo_settings.canonical_url }}">
    {% else %}
    <link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{{ request.path }}">
    {% endif %}
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="{% if seo_settings and seo_settings.og_type %}{{ seo_settings.og_type }}{% else %}website{% endif %}">
    <meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}{{ request.path }}">
    <meta property="og:locale" content="tr_TR">
    {% if seo_settings %}
        {% if seo_settings.og_title %}
        <meta property="og:title" content="{{ seo_settings.og_title }}">
        {% endif %}
        {% if seo_settings.og_description %}
        <meta property="og:description" content="{{ seo_settings.og_description }}">
        {% endif %}
        {% if seo_settings.og_image %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ seo_settings.og_image.url }}">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        {% endif %}
        {% if seo_settings.og_image_alt %}
        <meta property="og:image:alt" content="{{ seo_settings.og_image_alt }}">
        {% endif %}
    {% endif %}
    
    <!-- Twitter Card Meta Tags -->
    {% if seo_settings %}
        <meta name="twitter:card" content="{% if seo_settings.twitter_card %}{{ seo_settings.twitter_card }}{% else %}summary_large_image{% endif %}">
        {% if seo_settings.twitter_site %}
        <meta name="twitter:site" content="{{ seo_settings.twitter_site }}">
        {% endif %}
        {% if seo_settings.twitter_creator %}
        <meta name="twitter:creator" content="{{ seo_settings.twitter_creator }}">
        {% endif %}
        {% if seo_settings.og_title %}
        <meta name="twitter:title" content="{{ seo_settings.og_title }}">
        {% endif %}
        {% if seo_settings.og_description %}
        <meta name="twitter:description" content="{{ seo_settings.og_description }}">
        {% endif %}
        {% if seo_settings.og_image %}
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ seo_settings.og_image.url }}">
        <meta name="twitter:image:alt" content="{{ seo_settings.og_image_alt }}">
        {% endif %}
    {% endif %}
    
    <!-- Favicon -->
    {% if global_site_settings and global_site_settings.favicon %}
    <link rel="icon" type="image/x-icon" href="{{ global_site_settings.favicon.url }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ global_site_settings.favicon.url }}">
    {% else %}
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    {% endif %}
    
    <!-- Google Search Console Verification -->
    {% if global_site_settings and global_site_settings.google_search_console_verification %}
    {{ global_site_settings.google_search_console_verification|safe }}
    {% endif %}
    
    <!-- Google Analytics -->
    {% if global_site_settings and global_site_settings.google_analytics_id %}
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ global_site_settings.google_analytics_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ global_site_settings.google_analytics_id }}');
    </script>
    {% endif %}
    
    <!-- Bootstrap 5 CSS - Preload for better performance -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>
    
    <!-- Bootstrap Icons - Deferred with font-display optimization -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"></noscript>
    
    <!-- Font Display Optimization for Bootstrap Icons -->
    <style>
        @font-face {
            font-family: "bootstrap-icons";
            src: url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/fonts/bootstrap-icons.woff2?2ab2cbb4d6701484f4e2fb8d3e93c0a7") format("woff2"),
                 url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/fonts/bootstrap-icons.woff?2ab2cbb4d6701484f4e2fb8d3e93c0a7") format("woff");
            font-display: swap;
        }
    </style>
    
    <!-- Fancybox CSS - Deferred for better performance -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css"></noscript>
    
    <!-- Google Fonts - Already optimized with display=swap -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- Critical CSS - Inlined for faster initial render -->
    <style>
        :root{--primary-color:#0d6efd;--secondary-color:#6c757d;--success-color:#198754;--danger-color:#dc3545;--warning-color:#ffc107;--info-color:#0dcaf0;--light-color:#f8f9fa;--dark-color:#212529;--font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;--accent-color:#ff6b35;--gradient-start:#6a11cb;--gradient-end:#2575fc;--dark-accent:#2c3e50}
        body{font-family:var(--font-family);color:var(--dark-color);line-height:1.6;overflow-x:hidden;margin:0}
        h1,h2,h3,h4,h5,h6{font-weight:800;color:var(--dark-color);letter-spacing:-.5px}
        a{text-decoration:none;transition:all .3s ease}
        .navbar{padding:1rem 0;background:rgba(255,255,255,.95)!important;backdrop-filter:blur(10px);box-shadow:0 2px 20px rgba(0,0,0,.1)}
        .navbar-brand{font-size:1.8rem;font-weight:800;background:linear-gradient(45deg,var(--gradient-start),var(--gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .nav-link{font-weight:600;margin:0 .7rem;color:var(--dark-accent);position:relative;padding:.5rem 0;transition:all .3s ease}
        .nav-link:hover,.nav-link.active{color:var(--accent-color)}
        .nav-link.active::after{content:'';position:absolute;bottom:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,var(--gradient-start),var(--gradient-end));border-radius:3px}
        .hero-section{background:linear-gradient(135deg,rgba(106,17,203,.9),rgba(37,117,252,.8)),url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=1600&auto=format&fit=crop&q=80');background-size:cover;background-position:center;background-attachment:fixed;min-height:70vh;display:flex;align-items:center;color:#fff;position:relative;overflow:hidden}
        .hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(106,17,203,.85),rgba(37,117,252,.75));z-index:1}
        .hero-section .container{position:relative;z-index:2}
        .hero-section h1{font-size:3.5rem;font-weight:900;text-shadow:2px 4px 8px rgba(0,0,0,.3);animation:fadeInUp 1s ease}
        .hero-section p{font-size:1.3rem;margin:1.5rem 0;text-shadow:1px 2px 4px rgba(0,0,0,.2)}
        .logo-img{height:50px;width:180px;object-fit:contain}
        .footer-logo{height:40px;width:150px;object-fit:contain}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    </style>
    
    <!-- Non-Critical CSS - Deferred for better performance -->
    <link rel="preload" href="{% static 'css/style.css' %}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="{% static 'css/style.css' %}" rel="stylesheet"></noscript>
    
    <!-- Template-Specific Header Styles -->
    {% if about.homepage_template == 'template1' %}
        {% include 'headers/header_template1.html' %}
    {% elif about.homepage_template == 'template2' %}
        {% include 'headers/header_template2.html' %}
    {% elif about.homepage_template == 'template3' %}
        {% include 'headers/header_template3.html' %}
    {% elif about.homepage_template == 'template4' %}
        {% include 'headers/header_template4.html' %}
    {% else %}
        {% include 'headers/header_template1.html' %}
    {% endif %}
    
    {% block extra_css %}{% endblock %}
    
    <!-- Structured Data -->
    {% block structured_data %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "RealEstateAgent",
      "name": "Real Invest Gayrimenkul",
      "url": "{{ request.scheme }}://{{ request.get_host }}/",
      {% if global_site_settings and global_site_settings.logo %}
      "logo": "{{ request.scheme }}://{{ request.get_host }}{{ global_site_settings.logo.url }}",
      {% else %}
      "logo": "{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}",
      {% endif %}
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "{% if global_site_settings %}{{ global_site_settings.address }}{% endif %}",
        "addressLocality": "İstanbul",
        "addressCountry": "TR"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "{% if global_site_settings %}{{ global_site_settings.phone }}{% endif %}",
        "contactType": "customer service"
      }
    }
    </script>
    {% if seo_settings and seo_settings.structured_data %}
    {{ seo_settings.structured_data|safe }}
    {% endif %}
    {% endblock %}
</head>
<body class="{{ template_class }}{% block body_class %}{% endblock %}">
    <!-- DEBUG: Template Class = {{ template_class }} -->
    <!-- Header / Navigation -->
    <header class="header-section">
        <nav class="navbar navbar-expand-lg navbar-light sticky-top">
            <div class="container">
                <a class="navbar-brand" href="{% url 'home' %}">
                    {% if global_site_settings and global_site_settings.logo %}
                    <img src="{{ global_site_settings.logo.url }}" alt="Site Logo" class="logo-img" style="height: 50px; width: 180px; object-fit: contain;">
                    {% else %}
                    <i class="bi bi-buildings"></i> Emlak
                    {% endif %}
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">{{ nav_settings.home_label|default:"Ana Sayfa" }}</a>
                        </li>
                        {% if about.show_listings_page and listings_count > 0 %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'listings' %}active{% endif %}" href="{% url 'listings' %}">{{ nav_settings.listings_label|default:"İlanlar" }}</a>
                        </li>
                        {% endif %}
                        {% if about.show_construction_page and constructions_count > 0 %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'construction' %}active{% endif %}" href="{% url 'construction' %}">{{ nav_settings.construction_label|default:"İnşaatlar" }}</a>
                        </li>
                        {% endif %}
                        {% if about.show_references_page %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'references' %}active{% endif %}" href="{% url 'references' %}">{{ nav_settings.references_label|default:"Referanslar" }}</a>
                        </li>
                        {% endif %}
                        <!-- Hakkımızda linki kaldırıldı, içerik ana sayfada -->
                        {% if about.show_contact_page %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'contact' %}active{% endif %}" href="{% url 'contact' %}">{{ nav_settings.contact_label|default:"İletişim" }}</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% block content %}
        {% endblock %}
    </main>

    <!-- Floating WhatsApp and Phone Icons -->
    {% if global_site_settings %}
        {% if global_site_settings.show_whatsapp and global_site_settings.whatsapp_number %}
        <a href="https://wa.me/{{ global_site_settings.whatsapp_number }}" 
           class="floating-icon whatsapp-icon floating-{{ global_site_settings.whatsapp_position }}" 
           target="_blank" 
           aria-label="WhatsApp ile İletişim">
            <i class="bi bi-whatsapp"></i>
        </a>
        {% endif %}
        
        {% if global_site_settings.show_phone and global_site_settings.phone_number %}
        <a href="tel:{{ global_site_settings.phone_number }}" 
           class="floating-icon phone-icon floating-{{ global_site_settings.phone_position }}" 
           aria-label="Telefon ile İletişim">
            <i class="bi bi-telephone-fill"></i>
        </a>
        {% endif %}
    {% endif %}


    <!-- Footer -->
    {% if request.resolver_match.url_name == 'home' or request.resolver_match.url_name == 'contact' %}
    <footer class="footer-section">
        <div class="container">
            <div class="row">
                <!-- Şirket Bilgisi -->
                <div class="col-md-4 mb-4">
                    <h5>
                        {% if global_site_settings and global_site_settings.logo %}
                        <img src="{{ global_site_settings.logo.url }}" alt="Site Logo" class="logo-img" style="height: 100px; width: 180px; object-fit: contain;">
                        {% else %}
                        <i class="bi bi-buildings"></i> Emlak
                        {% endif %}
                    </h5>
                    <p>Mükemmel gayrimenkul bulmak için güvenilir ortağınız. Her ihtiyacınız için geniş emlak çözümleri sunuyoruz.</p>
                    <!-- Social Media -->
                    {% if global_site_settings %}
                    <div class="social-links mt-3">
                        {% if global_site_settings.facebook_url %}
                        <a href="{{ global_site_settings.facebook_url }}" target="_blank" rel="noopener noreferrer" aria-label="Facebook'ta takip edin" title="Facebook"><i class="bi bi-facebook"></i></a>
                        {% endif %}
                        {% if global_site_settings.instagram_url %}
                        <a href="{{ global_site_settings.instagram_url }}" target="_blank" rel="noopener noreferrer" aria-label="Instagram'da takip edin" title="Instagram"><i class="bi bi-instagram"></i></a>
                        {% endif %}
                        {% if global_site_settings.twitter_url %}
                        <a href="{{ global_site_settings.twitter_url }}" target="_blank" rel="noopener noreferrer" aria-label="Twitter'da takip edin" title="Twitter"><i class="bi bi-twitter"></i></a>
                        {% endif %}
                        {% if global_site_settings.linkedin_url %}
                        <a href="{{ global_site_settings.linkedin_url }}" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn'de takip edin" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Hızlı Linkler -->
                <div class="col-md-4 mb-4">
                    <h5>Hızlı Linkler</h5>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'home' %}"><i class="bi bi-chevron-right"></i> Ana Sayfa</a></li>
                        {% if about.show_listings_page and listings_count > 0 %}
                        <li><a href="{% url 'listings' %}"><i class="bi bi-chevron-right"></i> İlanlar</a></li>
                        {% endif %}
                        {% if about.show_construction_page and constructions_count > 0 %}
                        <li><a href="{% url 'construction' %}"><i class="bi bi-chevron-right"></i> İnşaatlar</a></li>
                        {% endif %}
                        {% if about.show_references_page %}
                        <li><a href="{% url 'references' %}"><i class="bi bi-chevron-right"></i> Referanslar</a></li>
                        {% endif %}
                        <!-- Hakkımızda linki kaldırıldı -->
                        {% if about.show_contact_page %}
                        <li><a href="{% url 'contact' %}"><i class="bi bi-chevron-right"></i> İletişim</a></li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- İletişim Bilgileri -->
                <div class="col-md-4 mb-4">
                    <h5>İletişim Bilgileri</h5>
                    <ul class="list-unstyled">
                        {% if global_site_settings and global_site_settings.address %}
                        <li class="mb-2"><i class="bi bi-geo-alt-fill me-2"></i> {{ global_site_settings.address }}</li>
                        {% else %}
                        <li class="mb-2"><i class="bi bi-geo-alt-fill me-2"></i> Örnek Mahallesi, Emlak Cad. No:123</li>
                        {% endif %}
                        
                        {% if global_site_settings and global_site_settings.phone %}
                        <li class="mb-2"><i class="bi bi-telephone-fill me-2"></i> {{ global_site_settings.phone }}</li>
                        {% else %}
                        <li class="mb-2"><i class="bi bi-telephone-fill me-2"></i> +90 212 123 45 67</li>
                        {% endif %}
                        
                        {% if global_site_settings and global_site_settings.email %}
                        <li class="mb-2"><i class="bi bi-envelope-fill me-2"></i> {{ global_site_settings.email }}</li>
                        {% else %}
                        <li class="mb-2"><i class="bi bi-envelope-fill me-2"></i> info@emlak.com</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <!-- Vergi Bilgileri -->
            {% if global_site_settings and global_site_settings.tax_number %}
            <div class="row">
                <div class="col-12 text-center mt-3">
                    <p class="mb-0">
                        <strong>Vergi Bilgileri:</strong> 
                        {{ global_site_settings.tax_number }}
                        {% if global_site_settings.tax_office %} {{ global_site_settings.tax_office }} {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
            
            <div class="footer-bottom">
                <div class="row">
                    <div class="col-12 text-center">
                        <p class="mb-0">&copy; {% now "Y" %} Emlak. Tüm hakları saklıdır.</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    {% endif %}

    <!-- Newsletter Popup Modal -->
    {% if popup_settings and popup_settings.enabled %}
    <div class="modal fade" id="newsletterModal" tabindex="-1" aria-labelledby="newsletterModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="newsletterModalLabel">
                        <i class="bi bi-envelope-heart"></i> {{ popup_settings.title }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">{{ popup_settings.description }}</p>
                    
                    <form id="newsletterForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="newsletter_name" class="form-label">Adınız Soyadınız</label>
                            <input type="text" class="form-control" id="newsletter_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="newsletter_email" class="form-label">E-posta Adresiniz</label>
                            <input type="email" class="form-control" id="newsletter_email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="newsletter_phone" class="form-label">Telefon Numaranız <small class="text-muted">(Opsiyonel)</small></label>
                            <input type="tel" class="form-control" id="newsletter_phone" name="phone" placeholder="05XX XXX XX XX">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="dont_show_again" name="dont_show_again">
                            <label class="form-check-label" for="dont_show_again">
                                Bir daha gösterme
                            </label>
                        </div>
                        <div id="newsletterMessage" class="alert" style="display: none;"></div>
                        <button type="submit" class="btn w-100" style="background-color: {{ popup_settings.button_color }}; color: white;">
                            <i class="bi bi-envelope-check"></i> {{ popup_settings.button_text }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bootstrap 5 JS Bundle - Load early for functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Fancybox JS - Load before custom scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
    
    <!-- Initialize Fancybox after it's loaded -->
    <script>
        if (typeof Fancybox !== 'undefined') {
            // Fancybox is loaded, initialize it
            Fancybox.bind("[data-fancybox]", {
                // Fancybox options
            });
        }
    </script>
    
    <!-- Custom JS - Deferred -->
    <script src="{% static 'js/script.js' %}" defer></script>
    
    <!-- Newsletter Popup Script -->
    {% if popup_settings and popup_settings.enabled %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user has dismissed the popup
        const newsletterDismissed = getCookie('newsletter_dismissed');
        
        if (!newsletterDismissed) {
            // Show popup after delay
            setTimeout(function() {
                {% if popup_settings.show_on_mobile or 'not a mobile device' %}
                const newsletterModal = new bootstrap.Modal(document.getElementById('newsletterModal'));
                newsletterModal.show();
                {% endif %}
            }, {{ popup_settings.delay_seconds }}000);
        }
        
        // Handle modal close button - check if "don't show again" is checked
        const newsletterModalEl = document.getElementById('newsletterModal');
        if (newsletterModalEl) {
            newsletterModalEl.addEventListener('hide.bs.modal', function (event) {
                // Check if "don't show again" checkbox is checked
                const dontShowAgain = document.getElementById('dont_show_again');
                if (dontShowAgain && dontShowAgain.checked) {
                    setCookie('newsletter_dismissed', 'true', 365);
                }
            });
        }
        
        // Handle form submission
        const newsletterForm = document.getElementById('newsletterForm');
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(newsletterForm);
                const messageDiv = document.getElementById('newsletterMessage');
                const submitBtn = newsletterForm.querySelector('button[type="submit"]');
                
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gönderiliyor...';
                
                fetch('{% url "newsletter_subscribe" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (messageDiv) {
                            messageDiv.className = 'alert alert-success';
                            messageDiv.style.display = 'block';
                            messageDiv.textContent = data.message;
                        }
                        
                        // Cookie is now set by backend, but also set it here for immediate effect
                        setCookie('newsletter_dismissed', 'true', 365);
                        
                        // Close modal after 2 seconds
                        setTimeout(function() {
                            const newsletterModal = bootstrap.Modal.getInstance(document.getElementById('newsletterModal'));
                            if (newsletterModal) {
                                newsletterModal.hide();
                            }
                        }, 2000);
                    } else {
                        if (messageDiv) {
                            messageDiv.className = 'alert alert-danger';
                            messageDiv.style.display = 'block';
                            messageDiv.textContent = data.message;
                        }
                    }
                })
                .catch(error => {
                    if (messageDiv) {
                        messageDiv.className = 'alert alert-danger';
                        messageDiv.style.display = 'block';
                        messageDiv.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
                    }
                })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-envelope-check"></i> {{ popup_settings.button_text }}';
                });
            });
        }
        
        // Cookie helper functions
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        }
    });
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
</body>
</html>